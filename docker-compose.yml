# Versió de la sintaxi de Docker Compose
version: '3.8'

# Definició dels serveis (contenidors) que formen l'aplicació
services:
  # Servei per a l'aplicació web (Next.js)
  web:
    # Configuració de la construcció de la imatge de Docker
    build:
      context: ./apps/web  # El context és el directori de l'app Next.js
      dockerfile: Dockerfile # El nom del Dockerfile dins d'aquest directori
    # Mapeig de ports: exposa el port 3000 del contenidor al port 3000 de la teva màquina
    ports:
      - "3000:3000"
    # Volums: sincronitza el codi font local amb el del contenidor
    # Això permet que els canvis que facis al codi es reflecteixin a l'instant (Hot Reload)
    volumes:
      - ./apps/web:/app
      # Exclou node_modules del volum per utilitzar els del contenidor, que són més eficients
      - /app/node_modules
    # Nom del contenidor per identificar-lo fàcilment
    container_name: whoiswho-web
    # Variables d'entorn per a l'aplicació Next.js
    environment:
      - NODE_ENV=development
      # URL per connectar-se a Redis. 'redis' és el nom del servei de Redis definit a sota.
      - REDIS_URL=redis://redis:6379
    # Fa que aquest servei esperi que el servei 'redis' estigui llest abans d'arrencar
    depends_on:
      - redis
    # Manté el contenidor corrent per a desenvolupament interactiu
    stdin_open: true
    tty: true

  # Servei per a la base de dades Redis
  redis:
    # Utilitza la imatge oficial de Redis des de Docker Hub
    image: "redis:7-alpine"
    # Nom del contenidor
    container_name: whoiswho-redis
    # Mapeig de ports (opcional, útil per a debugging amb un client de Redis extern)
    ports:
      - "6379:6379"
    # Volum per a la persistència de dades
    # Les dades de Redis es guardaran al volum 'redis-data' i no es perdran en aturar el contenidor
    volumes:
      - redis-data:/data

# Definició dels volums amb nom
volumes:
  redis-data: